---
title: "R Packaging Workflow"
format:
  html:
    reference-location: margin
    other-links:
      - text: Regex Cheatsheet
        icon: bookmark-plus
        href: https://github.com/raredd/regex
      - text: RexEgg
        icon: bookmark-plus
        href: https://www.rexegg.com/
      - text: Regex in R
        icon: bookmark-plus
        href: https://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| message: false
#| warning: false
#| echo: false
#| cache: false
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "",
  dpi       = 300, 
  dev       = "ragg_png",
  out.width = "100%",
  fig.align = "center",
  fig.width = 8
)
options(scipen = 999, digits = 2)
library(usethis)
```


# Create A Package

```{r}
#| label: create-package
#| eval: false
usethis::create_package("C:/Path/To/Folder/<package-name>")

usethis::create_package(
  "C:/Users/Andrew/Desktop/Repositories/rvu",
  fields = list(
    Package = "rvu",
    Title = "Tidy Revenue Integrity Tools",
    "Authors@R" = utils::person(
      "Andrew", 
      "Bruce", 
      , 
      email = "andrewallenbruce@gmail.com", 
      role = c("aut", "cre", "cph")
      ),
    Maintainer = "Andrew Bruce <andrewallenbruce@gmail.com>",
    Description = "Revenue integrity tools.",
    License = "MIT + file LICENSE",
    URL = "https://github.com/andrewallenbruce/rvu",
    BugReports = "https://github.com/andrewallenbruce/rvu/issues")
  )
```

Connect to Git

```{r}
#| label: connect-git
#| eval: false
usethis::use_git()
```

_Will ask you to commit files to Git. Say yes._

Create Repository on GitHub

```{r}
#| label: connect-github
#| eval: false
usethis::use_github()
```

_Will ask you to commit files to GitHub. Say yes._

Add License & COC

```{r}
#| label: add-license
#| eval: false
usethis::use_mit_license("Your Full Name")
usethis::use_code_of_conduct("your@email.com")
```

Add README, Package Document, and News

```{r}
#| label: use-rmd
#| eval: false
usethis::use_readme_rmd()
usethis::use_package_doc()
usethis::use_news_md()
```

Use `{roxyglobals}`

```{r}
#| label: use-roxy
#| eval: false
roxyglobals::use_roxyglobals()
```

Use `{testthat}`

```{r}
#| label: use-testthat
#| eval: false
usethis::use_testthat(parallel = TRUE)
usethis::use_test("add-test")
```

Create `{pkgdown}` site

```{r}
#| label: use-pkgdown
#| eval: false
usethis::use_pkgdown_github_pages()
```

Use `_pkgdown.yml`

```{yaml, filename="_pkgdown.yml"}
#| label: pkgdown-yml
#| eval: false
url: https://andrewallenbruce.github.io/codex/

template:
  bootstrap: 5
  light-switch: true
  bslib:
    base_font: {google: "Roboto"}
    heading_font: {google: "Roboto Slab"}
    code_font: {google: "Source Code Pro"}

navbar:
  structure:
    left:
    - intro
    - reference
    - articles
    - tutorials
    - news
    right:
    - search
    - github
    - lightswitch
  components:
    reference:
      text: Reference
      href: reference/index.html
    search:
      search: []
    lightswitch:
      icon: fa-sun
      aria-label: Light switch
      id: lightswitch
      menu:
      - text: Light
        theme: light
        icon: fa-sun
      - text: Dark
        theme: dark
        icon: fa-moon
      - text: Auto
        theme: auto
        icon: fa-adjust
    news:
      text: Changelog
      href: news/index.html
    github:
      icon: fab fa-github fa-lg
      href: https://github.com/andrewallenbruce/codex/
      aria-label: GitHub
```

Example of Function Reference

```{yaml}
#| label: function-reference
#| eval: false
- title: Classifications
  desc: >
    Classification systems for added context and dimensionality reduction.
  contents:
  - betos
  - ndc_lookup
  - taxonomies
  - taxonomy_codes
  - taxonomy_crosswalk
- title: Utilities
  desc: >
    Various helper functions.
  contents:
  - change
  - geomean
  - years_df
  - duration_vec
  - summary_stats
  - add_counties
```


Run Before Committing

```{r}
#| label: last-steps
#| eval: false
devtools::check()
devtools::build_rmd("README.Rmd")
usethis::use_tidy_description()
```


# Add a `{pin}`

Call `usethis::use_data_raw("<dataset>")`

Add `pins_internal.R` file to `data-raw` directory

```{r filename="pins_internal.R"}
#| label: pins_internal
#| eval: false
pin_update <- function(x, name, title, description) {

  board <- pins::board_folder(
    here::here("inst/extdata/pins"))

  board |>
    pins::pin_write(
      x,
      name        = name,
      title       = title,
      description = description,
      type        = "qs")

  board |> pins::write_board_manifest()
}

delete_pins <- function(pin_names) {

  board <- pins::board_folder(
    here::here("inst/extdata/pins"))

  pins::pin_delete(board, names = pin_names)
}
```

Create a new pin

```{r filename="dataset.R"}
#| label: data_raw
#| eval: false
source(here::here("data-raw", "pins_internal.R"))

pin_update(
  dataset,
  name = "object_name",
  title = "Short Description",
  description = "Long Description"
)
```

Add `pins.R` file to package

```{r filename="pins.R"}
#| label: pins_functions
#| eval: false

#' Return GitHub raw url
#'
#' @param x `<chr>` string
#'
#' @returns `<chr>` GitHub raw url
#'
#' @examples
#' gh_raw("andrewbruce/example/main/inst/pins/")
#'
#' @autoglobal
#'
#' @keywords internal
#'
#' @export
gh_raw <- function(x) {
  paste0("https://raw.githubusercontent.com/", x)
}

#' Mount [pins][pins::pins-package] board
#'
#' @param source `<chr>` `"local"` or `"remote"`
#'
#' @param package `<chr>` package name
#'
#' @returns `<pins_board_folder>` or `<pins_board_url>`
#'
#' @autoglobal
#' 
#' @importFrom pins board_folder board_url
#' @importFrom fs path_package
#' @importFrom glue glue
#'
#' @keywords internal
#'
#' @export
mount_board <- function(source = c("local", "remote"), package = "<package_name>") {

  source <- match.arg(source)

  switch(
    source,
    local = board_folder(
      path_package("extdata/pins", package = package)
      ),
    remote = board_url(
      gh_raw(
        glue("andrewallenbruce/{package}/master/inst/extdata/pins/")
        )
      ),
    stop("Invalid source")
    )
}

#' Get a pinned dataset from a [pins][pins::pins-package] board
#'
#' @param pin `<chr>` string name of pinned dataset
#'
#' @param ... additional arguments passed to `mount_board()`
#'
#' @returns `<tibble>` or `<data.frame>`
#'
#' @autoglobal
#' 
#' @importFrom pins pin_read
#'
#' @keywords internal
#'
#' @export
get_pin <- function(pin, ...) {

  board <- mount_board(...)

  pin <- match.arg(pin, list_pins())

  pin_read(board, pin)
}

#' List pins from a [pins][pins::pins-package] board
#'
#' @param ... arguments to pass to [mount_board()]
#'
#' @returns `<list>` of [pins][pins::pins-package]
#'
#' @autoglobal
#' 
#' @importFrom pins pin_list
#'
#' @keywords internal
#'
#' @export
list_pins <- function(...) {

  board <- mount_board(...)

  pin_list(board)
}
```


## Session Information 

```{r}
#| echo: false
pander::pander(sessionInfo())
```
