---
title: "R Packaging Workflow"
format:
  html:
    reference-location: margin
    other-links:
      - text: Regex Cheatsheet
        icon: bookmark-plus
        href: https://github.com/raredd/regex
      - text: RexEgg
        icon: bookmark-plus
        href: https://www.rexegg.com/
      - text: Regex in R
        icon: bookmark-plus
        href: https://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| message: false
#| warning: false
#| echo: false
#| cache: false
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "",
  dpi       = 300, 
  dev       = "ragg_png",
  out.width = "100%",
  fig.align = "center",
  fig.width = 8
)
options(scipen = 999, digits = 2)
library(usethis)
```


# Create A Package

```{r}
#| label: create-package
#| eval: false
create_package("C:/Path/To/Folder/<package-name>")
```

Connect to Git

```{r}
#| label: connect-git
#| eval: false
use_git()
```

_Will ask you to commit files to Git. Say yes._

Create Repository on GitHub

```{r}
#| label: connect-github
#| eval: false
use_github()
```

_Will ask you to commit files to GitHub. Say yes._

Add License & COC

```{r}
#| label: add-license
#| eval: false
use_mit_license("Your Full Name")
use_code_of_conduct("your@email.com")
```

Add README, Package Document, and News

```{r}
#| label: use-rmd
#| eval: false
use_readme_rmd()
use_package_doc()
use_news_md()
```

Use `{roxyglobals}`

```{r}
#| label: use-roxy
#| eval: false
roxyglobals::use_roxyglobals()
```

Use `{testthat}`

```{r}
#| label: use-testthat
#| eval: false
use_testthat(parallel = TRUE)
use_test("add-test")
```

Create `{pkgdown}` site

```{r}
#| label: use-pkgdown
#| eval: false
use_pkgdown_github_pages()
```

Run Before Committing

```{r}
#| label: last-steps
#| eval: false
check()
build_rmd("README.Rmd")
use_tidy_description()
```


# Add a `{pin}`

Call `usethis::use_data_raw("<dataset>")`

Add `pins_internal.R` file to `data-raw` directory

```{r filename="pins_internal.R"}
#| label: pins_internal
#| eval: false
pin_update <- function(x, name, title, description) {

  board <- pins::board_folder(
    here::here("inst/extdata/pins")
    )

  board |>
    pins::pin_write(
      x,
      name        = name,
      title       = title,
      description = description,
      type        = "qs"
    )

  board |> pins::write_board_manifest()

}

delete_pins <- function(pin_names) {

  board <- pins::board_folder(
    here::here("inst/extdata/pins")
  )

  pins::pin_delete(board, names = pin_names)

}
```

Create a new pin

```{r filename="dataset.R"}
#| label: data_raw
#| eval: false
source(here::here("data-raw", "pins_internal.R"))

pin_update(
  dataset,
  name = "object_name",
  title = "Short Description",
  description = "Long Description"
)
```

Add `pins.R` file to package

```{r filename="pins.R"}
#| label: pins_functions
#| eval: false

#' Return GitHub raw url
#'
#' @param x `<chr>` string
#'
#' @returns `<chr>` GitHub raw url
#'
#' @examples
#' gh_raw("andrewbruce/example/main/inst/pins/")
#'
#' @autoglobal
#'
#' @keywords internal
#'
#' @export
gh_raw <- function(x) {
  paste0("https://raw.githubusercontent.com/", x)
}

#' Mount [pins][pins::pins-package] board
#'
#' @param source `<chr>` `"local"` or `"remote"`
#'
#' @param package `<chr>` package name
#'
#' @returns `<pins_board_folder>` or `<pins_board_url>`
#'
#' @autoglobal
#'
#' @keywords internal
#'
#' @export
mount_board <- function(source = c("local", "remote"), package = "<package_name>") {

  source <- match.arg(source)

  switch(
    source,
    local = pins::board_folder(
      fs::path_package("extdata/pins", package = package)),
    remote = pins::board_url(
      gh_raw(
        glue::glue("andrewallenbruce/{package}/master/inst/extdata/pins/")
      )
    )
  )
}

#' Get a pinned dataset from a [pins][pins::pins-package] board
#'
#' @param pin `<chr>` string name of pinned dataset
#'
#' @param ... additional arguments passed to `mount_board()`
#'
#' @returns `<tibble>` or `<data.frame>`
#'
#' @autoglobal
#'
#' @keywords internal
#'
#' @export
get_pin <- function(pin, ...) {

  board <- mount_board(...)

  pin <- rlang::arg_match0(pin, list_pins())

  pins::pin_read(board, pin)

}

#' List pins from a [pins][pins::pins-package] board
#'
#' @param ... arguments to pass to [mount_board()]
#'
#' @returns `<list>` of [pins][pins::pins-package]
#'
#' @autoglobal
#'
#' @keywords internal
#'
#' @export
list_pins <- function(...) {

  board <- mount_board(...)

  pins::pin_list(board)

}
```
