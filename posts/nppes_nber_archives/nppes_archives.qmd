---
title: "NPPES NPI Archives"
format:
  html:
    reference-location: block
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false

knitr::opts_chunk$set(
  dev = "ragg_png",
  dpi = 320,
  out.width = "100%",
  fig.width = 8,
  fig.asp = 0.818,
  fig.retina = 2,
  fig.align = "center",
  fig.show = "hold"
)
options(scipen = 999)

library(tidyverse)
library(data.table)
library(collapse)
library(fuimus)
library(codex)
library(nppez)

wk_2024_01_01 <- nppez:::get_pin("wk20240101")
wk_2024_01_22 <- nppez:::get_pin("wk20240122")
wk_2024_02_05 <- nppez:::get_pin("wk_20240205")
```

# January 1, 2024

```{r}
#| label: wk_2024_01_01
wk_2024_01_01_base <- wk_2024_01_01$basic |> 
  reframe(
    npi,
    entity = case_match(entity, "Ind" ~ "I", "Org" ~ "O", .default = entity),
    prefix = str_remove_all(prefix, "\\."),
    first_name = str_remove_all(first, "\\."),
    middle_name = str_remove_all(middle, "\\."),
    last_name = str_remove_all(last, "\\."),
    suffix = str_remove_all(suffix, "\\."),
    credential = str_remove_all(credential, "\\."),
    gender,
    last_update = updated,
    cert_date = certified,
    enum_date,
    deact_date,
    react_date,
    sole_prop,
    org_subpart = org_sub,
    parent_org_lbn = str_remove_all(parent_org_lbn, "\\.|,"),
    prov_org_lbn = str_remove_all(prov_org_lbn, "\\.|,"))
```


### Deactivated

Remove deactivated NPIs with no reactivation date

```{r}
#| label: wk_2024_01_01_deact
wk_2024_01_01_deact <- wk_2024_01_01_base |> 
  filter(not_na(deact_date), 
         !not_na(react_date)) |> 
  remove_quiet()

wk_2024_01_01_deact_npi <- sf_convert(uniq_narm(wk_2024_01_01_deact$npi))

length(wk_2024_01_01_deact_npi)

wk_2024_01_01_deact |> fcount(deact_date)
```

> *Deactivated NPIs with Reactivation date*

```{r}
wk_2024_01_01_base |> 
  filter(not_na(deact_date), 
         not_na(react_date)) |> 
  arrange(desc(deact_date))
```

## Base

```{r}
#| label: wk_2024_01_01_ind_org
wk_2024_01_01_ind <- wk_2024_01_01_base |> 
  fsubset(npi %!in% wk_2024_01_01_deact_npi) |> 
  fsubset(entity %in% "I") |> 
  remove_quiet()

wk_2024_01_01_org <- wk_2024_01_01_base |> 
  fsubset(npi %!in% wk_2024_01_01_deact_npi) |> 
  fsubset(entity %in% "O") |> 
  remove_quiet()

wk_2024_01_01_ind
wk_2024_01_01_org
```

## Address

```{r}
#| label: wk_2024_01_01_address
wk_2024_01_01_address <- wk_2024_01_01$address |> 
  fsubset(!npi %in% wk_2024_01_01_deact_npi) |> 
  select(
    npi,
    ends_with("address"),
    ends_with("city"),
    ends_with("state"),
    ends_with("zip"),
    ends_with("country"),
    ends_with("phone"),
    ends_with("fax"))

wk_2024_01_01_address
```

Exact match on all address fields

```{r}
#| label: wk_2024_01_01_address_exact
exact <- wk_2024_01_01_address |> 
  filter(
    mail_address == prac_address,
    mail_city == prac_city,
    mail_state == prac_state,
    mail_zip == prac_zip,
    mail_country == prac_country,
    mail_phone == prac_phone,
    mail_fax == prac_fax
    ) |> 
  select(-starts_with("prac_")) |> 
  fmutate(type = "Both") |>
  fselect(
    npi,
    type,
    address = mail_address,
    city = mail_city,
    state = mail_state,
    zip = mail_zip,
    country = mail_country,
    phone = mail_phone,
    fax = mail_fax)

exact
```

Match on all fields except fax

```{r}
#| label: wk_2024_01_01_address_fax
fax <- wk_2024_01_01_address |>             
  filter(
    npi %!in% exact$npi,        
    mail_address == prac_address, 
    mail_city == prac_city,
    mail_state == prac_state,
    mail_country == prac_country,
    mail_zip == prac_zip,
    mail_phone == prac_phone) |> 
  fcompute(
    npi = npi,
    type = "Both",
    address = mail_address,
    city = mail_city,
    state = mail_state,
    zip = mail_zip,
    country = mail_country,
    phone = mail_phone,
    fax = case_when(
      not_na(mail_fax) & not_na(prac_fax) & mail_fax == prac_fax ~ str_glue("M: {mail_fax}"),
      not_na(mail_fax) & not_na(prac_fax) & mail_fax != prac_fax ~ str_glue("M: {mail_fax} | P: {prac_fax}"),
      not_na(mail_fax) & !not_na(prac_fax) ~ str_glue("M: {mail_fax}"),
      !not_na(mail_fax) & not_na(prac_fax) ~ str_glue("P: {prac_fax}"),
      .default = NA_character_))

fax
```

Match on all fields except zip, phone, and fax

```{r}
#| label: wk_2024_01_01_address_zipphonefax
zipphonefax <- wk_2024_01_01_address |>             
  filter(
    npi %!in% c(exact$npi, fax$npi),        
    mail_address == prac_address,
    mail_city == prac_city,
    mail_state == prac_state,
    mail_country == prac_country) |>
  fcompute(
    npi = npi,
    type = "Both",
    address = mail_address,
    city = mail_city,
    state = mail_state,
    country = mail_country,
    zip = case_when(
      not_na(mail_zip) & not_na(prac_zip) & mail_zip == prac_zip ~ str_glue("M: {mail_zip}"),
      not_na(mail_zip) & not_na(prac_zip) & mail_zip != prac_zip ~ str_glue("M: {mail_zip} | P: {prac_zip}"),
      not_na(mail_zip) & is.na(prac_zip) ~ str_glue("M: {mail_zip}"),
      is.na(mail_zip) & not_na(prac_zip) ~ str_glue("P: {prac_zip}"),
      .default = NA_character_),
    phone = case_when(
      not_na(mail_phone) & not_na(prac_phone) & mail_phone == prac_phone ~ str_glue("M: {mail_phone}"),
      not_na(mail_phone) & not_na(prac_phone) & mail_phone != prac_phone ~ str_glue("M: {mail_phone} | P: {prac_phone}"),
      not_na(mail_phone) & is.na(prac_phone) ~ str_glue("M: {mail_phone}"),
      is.na(mail_phone) & not_na(prac_phone) ~ str_glue("P: {prac_phone}"),
      .default = NA_character_),
    fax = case_when(
      not_na(mail_fax) & not_na(prac_fax) & mail_fax == prac_fax ~ str_glue("M: {mail_fax}"),
      not_na(mail_fax) & not_na(prac_fax) & mail_fax != prac_fax ~ str_glue("M: {mail_fax} | P: {prac_fax}"),
      not_na(mail_fax) & is.na(prac_fax) ~ str_glue("M: {mail_fax}"),
      is.na(mail_fax) & not_na(prac_fax) ~ str_glue("P: {prac_fax}"),
      .default = NA_character_))

zipphonefax
```

Pivot remaining addresses

```{r}
#| label: wk_2024_01_01_address_pivot
pivot <- wk_2024_01_01_address |> 
  filter(npi %!in% c(exact$npi, fax$npi, zipphonefax$npi)) |> 
  pivot_longer(
    -npi, 
    names_to = "type_part", 
    values_to = "value", 
    names_transform = list(type_part = stringr::str_to_title)) |> 
  separate_wider_delim(
    type_part, 
    delim = "_", 
    names = c("type", "part")) |> 
  pivot_wider(names_from = part, values_from = value)

pivot
```

Combine all address matches

```{r}
#| label: wk_2024_01_01_address_clean
wk_2024_01_01_address_clean <- rbindlist(
  list(exact, fax, zipphonefax, pivot), 
  use.names = TRUE, 
  ignore.attr=TRUE) |> 
  join(wk_2024_01_01_base[.c(npi, entity)], on = "npi")

wk_2024_01_01_address_clean[entity == "I"]
wk_2024_01_01_address_clean[entity == "O"]
```

## Taxonomy

```{r}
#| label: wk_2024_01_01_taxonomy
wk_2024_01_01_taxonomy <- wk_2024_01_01$taxonomy |> 
  reframe(
    npi,
    tax_code = taxonomy_code,
    tax_group = taxonomy_group,
    tax_primary = taxonomy_primary,
    tax_license = license_number,
    tax_state = license_state) |> 
  left_join(wk_2024_01_01_base[c("npi", "entity")], by = join_by(npi))

wk_2024_01_01_taxonomy |> filter(entity == "I") |> remove_quiet()
wk_2024_01_01_taxonomy |> filter(entity == "O") |> remove_quiet()
```

## Identifiers

```{r}
#| label: wk_2024_01_01_identifier
wk_2024_01_01_id <- wk_2024_01_01$identifier |> 
  reframe(
    npi,
    identifier = other_id,
    identifier_type = other_id_code,
    identifier_state = other_id_state,
    identifier_issuer = other_id_issuer) |> 
  left_join(wk_2024_01_01_base[c("npi", "entity")], by = join_by(npi))

wk_2024_01_01_id |> filter(entity == "I") |> remove_quiet()
wk_2024_01_01_id |> filter(entity == "O") |> remove_quiet()
```

## Other

```{r}
#| label: wk_2024_01_01_other
wk_2024_01_01_other <- wk_2024_01_01$other |> 
  reframe(
    npi,
    other_org_name,
    other_org_type,
    other_prefix,
    other_first_name = other_first,
    other_middle_name = other_middle,
    other_last_name = other_last,
    other_last_type,
    other_suffix,
    other_credential
    ) |> 
  left_join(wk_2024_01_01_base[c("npi", "entity")], by = join_by(npi))

wk_2024_01_01_other |> filter(entity == "I") |> remove_quiet()
wk_2024_01_01_other |> filter(entity == "O") |> remove_quiet()
```

## Authorized

```{r}
#| label: wk_2024_01_01_authorized
wk_2024_01_01_ao <- wk_2024_01_01$authorized |> 
  reframe(
    npi,
    ao_prefix,
    ao_first_name = ao_first,
    ao_last_name = ao_last,
    ao_middle_name = ao_middle,
    ao_suffix,
    ao_title,
    ao_phone)

wk_2024_01_01_ao
```

<hr>

{{< pagebreak >}}

# January 22, 2024

## Deactivated

```{r}
#| label: wk_2024_01_22_deact
wk_2024_01_22_deact <- wk_2024_01_22$basic |> 
  filter(!is.na(deact_date), is.na(react_date)) |> 
  remove_quiet()

wk_2024_01_22_deact_npi <- sf_convert(uniq_narm(wk_2024_01_22_deact$npi))

length(wk_2024_01_22_deact_npi)

wk_2024_01_22_deact |> count(deact_date)
```

```{r}
wk_2024_01_01_basic |> filter(npi %in% wk_2024_01_22_deact_npi)
```

## Base

```{r}
#| label: wk_2024_01_22_basic
wk_2024_01_22_basic <- filter(wk_2024_01_22$basic, !npi %in% wk_2024_01_22_deact_npi)
wk_2024_01_22_ind <- filter(wk_2024_01_22_basic, entity == "Ind") |> remove_quiet()
wk_2024_01_22_org <- filter(wk_2024_01_22_basic, entity == "Org") |> remove_quiet()

wk_2024_01_22_ind
wk_2024_01_22_org
```


## Address

```{r}
#| label: wk_2024_01_22_address
wk_2024_01_22$address |> 
  filter(!npi %in% wk_2024_01_22_deact_npi) |> 
  pivot_longer(-npi, names_to = "type_part", values_to = "value") |> 
  separate_wider_delim(type_part, delim = "_", names = c("type", "part")) |> 
  pivot_wider(names_from = part, values_from = value) |> 
  mutate(type = case_match(type,
                           "mail" ~ "Mailing",
                           "prac" ~ "Practice",
                           .default = type))
```

## Taxonomy

```{r}
#| label: wk_2024_01_22_taxonomy
wk_2024_01_22$taxonomy

wk_2024_01_22_taxonomy <- wk_2024_01_22$taxonomy |> 
  reframe(
    npi,
    txn_code = taxonomy_code,
    txn_group = taxonomy_group,
    txn_primary = taxonomy_primary,
    txn_license = license_number,
    txn_state = license_state) |> 
  left_join(wk_2024_01_22_basic[c("npi", "entity")], by = join_by(npi))

wk_2024_01_22_taxonomy |> filter(entity == "Ind") |> remove_quiet()
wk_2024_01_22_taxonomy |> filter(entity == "Org") |> remove_quiet()
```

## Identifiers

```{r}
#| label: wk_2024_01_22_identifier
wk_2024_01_22$identifier

wk_2024_01_22_id <- wk_2024_01_22$identifier |> 
  reframe(
    npi,
    id = other_id,
    id_type = other_id_code,
    id_state = other_id_state,
    id_issuer = other_id_issuer) |> 
  left_join(wk_2024_01_22_basic[c("npi", "entity")], by = join_by(npi))

wk_2024_01_22_id |> filter(entity == "Ind") |> remove_quiet()
wk_2024_01_22_id |> filter(entity == "Org") |> remove_quiet()
```

## Other

```{r}
#| label: wk_2024_01_22_other
wk_2024_01_22_other <- wk_2024_01_22$other |> 
  reframe(
    npi,
    other_org_name,
    other_org_type,
    other_prefix,
    other_first_name = other_first,
    other_middle_name = other_middle,
    other_last_name = other_last,
    other_last_type,
    other_suffix,
    other_credential
    ) |> 
  left_join(wk_2024_01_22_basic[c("npi", "entity")], by = join_by(npi))

wk_2024_01_22_other |> filter(entity == "Ind") |> remove_quiet()
wk_2024_01_22_other |> filter(entity == "Org") |> remove_quiet()
```

## Authorized

```{r}
#| label: wk_2024_01_22_authorized
wk_2024_01_22_ao <- wk_2024_01_22$authorized |> 
  reframe(
    npi,
    ao_prefix,
    ao_first_name = ao_first,
    ao_last_name = ao_last,
    ao_middle_name = ao_middle,
    ao_suffix,
    ao_title,
    ao_phone)

wk_2024_01_22_ao
```

<hr>

{{< pagebreak >}}

# February 05, 2024

## Deactivated

```{r}
#| label: wk_2024_02_05_deact
wk_2024_02_05_deact <- wk_2024_02_05$basic |> 
  filter(!is.na(deact_date), is.na(react_date)) |> 
  remove_quiet()

wk_2024_02_05_deact_npi <- sf_convert(uniq_narm(wk_2024_02_05_deact$npi))

length(wk_2024_02_05_deact_npi)

wk_2024_02_05_deact |> count(deact_date)
```

<hr>

{{< pagebreak >}}


## Session Information 

```{r}
#| echo: false
pander::pander(sessionInfo())
```
