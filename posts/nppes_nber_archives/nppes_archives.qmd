---
title: "NPPES NPI Archives"
format:
  html:
    reference-location: block
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false

knitr::opts_chunk$set(
  dev = "ragg_png",
  dpi = 320,
  out.width = "100%",
  fig.width = 8,
  fig.asp = 0.818,
  fig.retina = 2,
  fig.align = "center",
  fig.show = "hold"
)
options(scipen = 999, digits = 3)

library(tidyverse)
library(data.table)
library(collapse)
library(fuimus)
library(codex)
library(nppez)
library(arktax)
library(hacksaw)

wk_2024_01_01 <- nppez:::get_pin("wk20240101")
# wk_2024_01_22 <- nppez:::get_pin("wk20240122")
# wk_2024_02_05 <- nppez:::get_pin("wk_20240205")
```

# 2024-01-01

```{r}
#| label: w241_base
w241_base <- wk_2024_01_01$basic |> 
  fcompute(
    npi = npi,
    entity = data.table::fcase(entity == "Ind", "I", entity == "Org", "O"),
    prefix = sf_remove(prefix, "\\."),
    first_name = sf_remove(first, "\\."),
    middle_name = sf_remove(middle, "\\."),
    last_name = sf_remove(last, "\\."),
    suffix = sf_remove(suffix, "\\."),
    credential = sf_remove(credential, "\\."),
    org_parent = sf_remove(parent_org_lbn, "\\.|,"),
    org_prov = sf_remove(prov_org_lbn, "\\.|,"),
    cert_date = certified,
    enum_date = enum_date,
    deact_date = deact_date,
    react_date = react_date,
    sole_prop = sole_prop,
    org_subpart = org_sub
    )

# Isolate deactivated NPIs with no reactivation date
w241_deact <- remove_quiet(
  w241_base[
    not_na(w241_base$deact_date) & 
      !not_na(w241_base$react_date), ]
  )

# Remove them from base frame
w241_base <- fsubset(w241_base, npi %!in% w241_deact$npi)

# Split into individuals and organizations
base_g <- GRP(w241_base, ~ entity)

rsplit(w241_base, base_g) |> 
  map(remove_quiet) |> 
  setNames(GRPnames(base_g))
```

### Other Transformations to Keep in Mind

```{r}
# Credentials in Last Name
w241_base |> 
  fsubset(sf_detect(last_name, ", ")) |> 
  fsubset(is.na(credential))
```


```{r}
base_g <- GRP(w241_base, ~ entity)

w241_base_spl <- rsplit(w241_base, base_g) |> 
  map(remove_quiet) |> 
  setNames(GRPnames(base_g))

w241_base_spl

# Org NPIs that are org_subpart have org_parent names
rsplit(w241_base_spl$O, w241_base_spl$O$org_subpart)

# Individuals - Sole Proprietors
rsplit(w241_base_spl$I, w241_base_spl$I$sole_prop)
```


## Address

```{r}
#| label: w241_add
w241_add <- join(
  wk_2024_01_01$address, 
  w241_base[c("npi", "entity")], 
  on = "npi", 
  verbose = 0) |> 
  fsubset(npi %!in% w241_deact$npi)

make_case <- function(x, y) {
  fcase(
    not_na(x) & not_na(y) & x == y, str_glue("{y}"), 
    not_na(x) & not_na(y) & x != y, str_glue("{x}, {y}"), 
    not_na(x) & cheapr::is_na(y), str_glue("{x}"), 
    cheapr::is_na(x) & not_na(y), str_glue("{y}")
  )
}

make_zip <- function(x) {
  map_chr(
    x, 
    function(x) {
      if (not_na(x) & nchar(x) == 9) 
        str_glue(
          "{substr(x, 1, 5)}-{substr(x, 6, 9)}"
          )
      else 
        x
    }
  )
}

make_phone <- function(x) {
  map_chr(
    x, 
    function(x) {
      if (not_na(x) & nchar(x) == 10) 
        str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}")
      else 
        x
    }
  )
}

fax = map_chr(
      fax, \(x) if (not_na(x)) {
        if (nchar(x) == 10) {
          str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}")
          } else if (nchar(x) > 10) {
            str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}, ({substr(x, 13, 15)})-{substr(x, 16, 18)}-{substr(x, 19, 22)}")
            } 
        } 
      else x
      )


# Exact match on all address fields
w241_exact <- w241_add |> 
  filter(
    mail_address == prac_address,
    mail_city == prac_city,
    mail_state == prac_state,
    mail_zip == prac_zip,
    mail_country == prac_country,
    mail_phone == prac_phone,
    mail_fax == prac_fax) |> 
  fcompute(
    npi = npi,
    entity = entity,
    purpose = "MP",
    address = prac_address,
    city = prac_city,
    state = prac_state,
    zip = make_zip(prac_zip),
    country = prac_country,
    phone = make_phone(prac_phone),
    fax = make_phone(prac_fax))

# Match on all except FAX
w241_fax <- w241_add |> 
  filter(
    npi %!in% w241_exact$npi,  
    mail_address == prac_address, 
    mail_city == prac_city,
    mail_state == prac_state,
    mail_country == prac_country,
    mail_zip == prac_zip,
    mail_phone == prac_phone) |> 
  fcompute(
    npi = npi,
    entity = entity,
    address = prac_address,
    city = prac_city,
    state = prac_state,
    zip = make_zip(prac_zip),
    country = prac_country,
    phone = make_phone(prac_phone),
    fax = make_case(mail_fax, prac_fax),
    purpose = fcase(
      not_na(mail_fax) & !not_na(prac_fax), "M",
      !not_na(mail_fax) & not_na(prac_fax), "P",
      default = "MP")) |> 
  fmutate(
    fax = map_chr(
      fax, \(x) if (not_na(x)) {
        if (nchar(x) == 10) {
          str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}")
          } else if (nchar(x) > 10) {
            str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}, ({substr(x, 13, 15)})-{substr(x, 16, 18)}-{substr(x, 19, 22)}")
            } 
        } 
      else x
      )
    )

# Match on all except ZIP, PHONE, and FAX
w241_phone <- w241_add |> 
  filter(
    npi %!in% c(w241_exact$npi, w241_fax$npi),      
    mail_address == prac_address,
    mail_city == prac_city,
    mail_state == prac_state,
    mail_country == prac_country) |>
  fcompute(
    npi = npi,
    entity = entity,
    purpose = fcase(not_na(mail_phone) & !not_na(prac_phone), "M",
                    !not_na(mail_phone) & not_na(prac_phone), "P",
                    default = "MP"),
    address = prac_address,
    city = prac_city,
    state = prac_state,
    zip = fcase(
      not_na(mail_zip) & not_na(prac_zip) & mail_zip == prac_zip, str_glue("{prac_zip}"),
      not_na(mail_zip) & not_na(prac_zip) & mail_zip != prac_zip, str_glue("{mail_zip}, {prac_zip}"),
      not_na(mail_zip) & !not_na(prac_zip), str_glue("{mail_zip}"),
      !not_na(mail_zip) & not_na(prac_zip), str_glue("{prac_zip}")),
    country = prac_country,
    phone = fcase(
      not_na(mail_phone) & not_na(prac_phone) & mail_phone == prac_phone, str_glue("{prac_phone}"),
      not_na(mail_phone) & not_na(prac_phone) & mail_phone != prac_phone, str_glue("{mail_phone}, {prac_phone}"),
      not_na(mail_phone) & !not_na(prac_phone), str_glue("{mail_phone}"),
      !not_na(mail_phone) & not_na(prac_phone), str_glue("{prac_phone}")),
    fax = fcase(
      not_na(mail_fax) & not_na(prac_fax) & mail_fax == prac_fax, str_glue("{prac_fax}"),
      not_na(mail_fax) & not_na(prac_fax) & mail_fax != prac_fax, str_glue("{mail_fax}, {prac_fax}"),
      not_na(mail_fax) & !not_na(prac_fax), str_glue("{mail_fax}"),
      !not_na(mail_fax) & not_na(prac_fax), str_glue("{prac_fax}"))) |> 
  fmutate(
    zip = map_chr(zip, \(x) if (not_na(x) & nchar(x) == 9) str_glue("{substr(x, 1, 5)}-{substr(x, 6, 9)}") else x), 
    phone = map_chr(
      phone, \(x) if (not_na(x)) {
        if (nchar(x) == 10) {
          str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}")
          } else if (nchar(x) > 10) {
            str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}, ({substr(x, 13, 15)})-{substr(x, 16, 18)}-{substr(x, 19, 22)}")
            } 
        } 
      else x
      ),
    fax = map_chr(
      fax, \(x) if (not_na(x)) {
        if (nchar(x) == 10) {
          str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}")
          } else if (nchar(x) > 10) {
            str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}, ({substr(x, 13, 15)})-{substr(x, 16, 18)}-{substr(x, 19, 22)}")
            } 
        } 
      else x
      )
    )

# Pivot remaining addresses
w241_piv <- w241_add |> 
  filter(npi %!in% c(w241_exact$npi, w241_fax$npi, w241_phone$npi)) |> 
  pivot_longer(
    -c(npi, entity), 
    names_to = "type_part", 
    values_to = "value", 
    names_transform = list(type_part = stringr::str_to_title)) |> 
  separate_wider_delim(
    type_part, 
    delim = "_", 
    names = c("type", "part")) |> 
  fmutate(
    purpose = case_when(
      type == "Mail" ~ "M",
      type == "Prac" ~ "P",
    .default = type),
    type = NULL
    ) |>
  pivot_wider(names_from = part, values_from = value) |> 
  fmutate(
    zip = map_chr(zip, \(x) if (not_na(x) & nchar(x) == 9) str_glue("{substr(x, 1, 5)}-{substr(x, 6, 9)}") else x), 
    phone = map_chr(
      phone, \(x) if (not_na(x)) {
        if (nchar(x) == 10) {
          str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}")
          } else if (nchar(x) > 10) {
            str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}, ({substr(x, 13, 15)})-{substr(x, 16, 18)}-{substr(x, 19, 22)}")
            } 
        } 
      else x
      ),
    fax = map_chr(
      fax, \(x) if (not_na(x)) {
        if (nchar(x) == 10) {
          str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}")
          } else if (nchar(x) > 10) {
            str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}, ({substr(x, 13, 15)})-{substr(x, 16, 18)}-{substr(x, 19, 22)}")
            } 
        } 
      else x
      )
    )

# Combine all address matches
w241_add <- rowbind(w241_exact, w241_fax, w241_phone, w241_piv)

add_g <- GRP(w241_add, ~ entity)

rsplit(w241_add, add_g) |> 
  map(remove_quiet) |> 
  setNames(GRPnames(add_g))
```

## Taxonomy

```{r}
#| label: w241_tax
w241_tax <- join(
  wk_2024_01_01$taxonomy[c("npi", "taxonomy_code", "taxonomy_group", "taxonomy_primary")], 
  w241_base[c("npi", "entity")], 
  on = "npi", 
  verbose = 0) |> 
  fsubset(npi %!in% w241_deact$npi) |> 
  fmutate(
    level = fcase(
      taxonomy_primary == "Y", "Primary",
      taxonomy_primary == "N", "Other",
      taxonomy_primary == "X", "X"),
    taxonomy_primary = NULL)

w241_tax <- rowbind(
  w241_tax |> 
  fsubset(!not_na(taxonomy_group)) |> 
  fselect(-taxonomy_group) |> 
  distinct(),
  w241_tax |> 
  fsubset(not_na(taxonomy_group)) |> 
  fselect(-taxonomy_code, -level) |> 
  distinct() |> 
  frename(taxonomy_code = taxonomy_group) |> 
  fmutate(level = "Group"))

tax_g <- GRP(w241_tax, ~ entity)

w241_tax <- rsplit(w241_tax, tax_g) |> 
  map(remove_quiet) |> 
  setNames(GRPnames(tax_g))

w241_tax
```


### Duplicates

```{r}
w241_tax$O |> 
  mutate(N = n(), .by = npi) |> 
  filter(N == 2) |> 
  mutate(eq = taxonomy_code == flag(taxonomy_code), .by = npi) |> 
  filter(eq)

w241_tax$I |> 
  mutate(N = n(), .by = npi) |> 
  filter(N == 2) |> 
  mutate(eq = taxonomy_code == flag(taxonomy_code), .by = npi) |> 
  filter(eq)
```

## License

```{r}
#| label: w241_lic
w241_lic <- join(
  wk_2024_01_01$taxonomy[c("npi", "license_number", "license_state")], 
  w241_base[c("npi", "entity")], 
  on = "npi", 
  verbose = 0) |> 
  fsubset(npi %!in% w241_deact$npi)

lic_g <- GRP(w241_lic, ~ entity)

w241_lic <- rsplit(w241_lic, lic_g) |> 
  map(\(df) remove_quiet(df) |> filter(not_na(license_number))) |> 
  setNames(GRPnames(lic_g))

w241_lic
```

## Identifiers

```{r}
#| label: w241_id
w241_id <- join(
  wk_2024_01_01$identifier, 
  w241_base[c("npi", "entity")], 
  on = "npi", 
  verbose = 0) |> 
  fsubset(npi %!in% w241_deact$npi) |> 
  # Remove Taxonomy Codes
  fsubset(sf_ndetect(other_id, "^[A-Z0-9]{9}X$"))

id_g <- GRP(w241_id, ~ entity)

rsplit(w241_id, id_g) |> 
  map(remove_quiet) |> 
  setNames(GRPnames(id_g))
```

## Other

```{r}
#| label: w241_oth
w241_oth <- join(
  wk_2024_01_01$other, 
  w241_base[c("npi", "entity")], 
  on = "npi", 
  verbose = 0) |> 
  fsubset(npi %!in% w241_deact$npi) |> 
  fcompute(
    npi = npi,
    entity = entity,
    ao_prefix = sf_remove(ao_prefix, "\\."),
    ao_first_name = sf_remove(ao_first, "\\."),
    ao_middle_name = sf_remove(ao_middle, "\\."),
    ao_last_name = sf_remove(ao_last, "\\."),
    ao_suffix = sf_remove(ao_suffix, "\\."),
    ao_credential = sf_remove(ao_credential, "\\."),
    ao_title = sf_remove(ao_title, "\\."),
    ao_phone = map_chr(ao_phone, \(x) if (not_na(x)) str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}") else x)
  )

oth_g <- GRP(w241_oth, ~ entity)

w241_oth <- rsplit(w241_oth, oth_g) |> 
  map(remove_quiet) |> 
  setNames(GRPnames(oth_g))

w241_oth$I <- vctrs::vec_slice(w241_oth$I, cheapr::row_na_counts(w241_oth$I) < 6)

w241_oth
```

## Authorized

```{r}
#| label: w241_ao
w241_ao <- join(
  wk_2024_01_01$authorized, 
  w241_base[c("npi", "entity")], 
  on = "npi", 
  verbose = 0) |> 
  fsubset(npi %!in% w241_deact$npi) |> 
  fcompute(
    npi = npi,
    entity = entity,
    ao_prefix = sf_remove(ao_prefix, "\\."),
    ao_first_name = sf_remove(ao_first, "\\."),
    ao_middle_name = sf_remove(ao_middle, "\\."),
    ao_last_name = sf_remove(ao_last, "\\."),
    ao_suffix = sf_remove(ao_suffix, "\\."),
    ao_credential = sf_remove(ao_credential, "\\."),
    ao_title = sf_remove(ao_title, "\\."),
    ao_phone = map_chr(ao_phone, \(x) if (not_na(x)) str_glue("({substr(x, 1, 3)}) {substr(x, 4, 6)}-{substr(x, 7, 10)}") else x)
  )

w241_ao
```

<hr>

{{< pagebreak >}}


## Session Information 

```{r}
#| echo: false
pander::pander(sessionInfo())
```
