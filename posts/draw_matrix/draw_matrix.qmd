---
title: "Medical Codes as Matrices"
format:
  html:
    reference-location: block
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| echo: true
#| message: false
#| warning: false

knitr::opts_chunk$set(
  dev = "ragg_png",
  dpi = 320,
  out.width = "100%",
  fig.width = 8,
  fig.asp = 0.818,
  fig.retina = 2,
  fig.align = "center",
  fig.show = "hold"
)
options(scipen = 999)

library(tidyverse)
library(stringfish)
library(ggthemes)
library(drawr)
library(fuimus)
library(procedural)
library(northstar)
```

# Function

```{r}
#| echo: true
#| message: false
#| warning: false

med <- dplyr::lst(
  c_pcs = c(0:9, LETTERS[c(which(LETTERS %in% splitter("ABCDEFGHJKLMNPQRSTUVWXYZ")))]),
  c_hcp = c(0:9, LETTERS[c(which(LETTERS %in% splitter("ABCEFGHJKLMPQRSTUV")))]),
  p_pcs = 1:length(c_pcs),
  p_hcp = 1:length(c_hcp),
  a_pcs = 1:7,
  a_hcp = 1:5
  )

med_lookup <- function(code, constants, possible) {
  
  code <- splitter(sf_toupper(code))
  names(possible) <- constants
  unname(possible[code])
  
}

med_matrix <- function(code, axis, constants, possible) {
  
  m <- matrix(data     = 0L,
              nrow     = length(constants),
              ncol     = length(axis),
              dimnames = list(constants, axis))
  
  x <- med_lookup(code, constants, possible)
  
  for (i in axis) {
    m[x[i], i] <- 1L
  }
  
  return(m)
}
```

# Test

```{r}
#| echo: true
#| message: false
#| warning: false
med_matrix(code = "0G9000Z", 
           axis = med$a_pcs, 
           constants = med$c_pcs, 
           possible = med$p_pcs)
```


```{r}
#| echo: true
#| message: false
#| warning: false
med_matrix(code = "99213", 
           axis = med$a_hcp, 
           constants = med$c_hcp, 
           possible = med$p_hcp)
```


# Draw

```{r}
#| echo: true
#| message: false
#| warning: false
x_pcs <- med_matrix(code = "0G9000Z", 
                    axis = med$a_pcs, 
                    constants = med$c_pcs, 
                    possible = med$p_pcs)


gdraw_matrix(
  x_pcs, 
  highlight_area = x_pcs == 1, 
  show_indices = "none",
  graph_title = "ICD-10-PCS Code 0G9000Z",
  graph_subtitle = NULL) + 
  theme_solid() + 
  ylim(rev(rownames(x_pcs))) + 
  xlim(colnames(x_pcs)) + 
  xlab("") + 
  ylab("") +
  theme(
    legend.position = "none",
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    )
```

```{r}
#| echo: true
#| message: false
#| warning: false
x_hcpcs <- med_matrix(code = "99213", 
                      axis = med$a_hcp, 
                      constants = med$c_hcp, 
                      possible = med$p_hcp)


gdraw_matrix(
  x_hcpcs, 
  highlight_area = x_hcpcs == 1, 
  show_indices = "none",
  graph_title = "HCPCS Code 99213",
  graph_subtitle = NULL) + 
  theme_solid() + 
  ylim(rev(rownames(x_hcpcs))) + 
  xlim(colnames(x_hcpcs)) + 
  xlab("") + 
  ylab("") +
  theme(
    legend.position = "none",
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    )
```


{{< pagebreak >}}

## Session Info

```{r}
sessioninfo::session_info()
```
