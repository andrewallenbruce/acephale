{
  "hash": "592baf6417c50056a06ab1f36e9c3d29",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"provider: Metadata Caching\"\nformat:\n  html:\n    reference-location: block\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n# National Downloadable File\n\n   * [Data Dictionary](https://data.cms.gov/provider-data/sites/default/files/data_dictionaries/physician/DOC_Data_Dictionary.pdf)\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmeta_ndf <- \\(fn) {\n  \n  fn <- match.arg(fn, c(\"affiliations\", \"clinicians\"))\n\n  id <- c(affiliations = \"27ea-46a8\", clinicians = \"mj5m-pzi6\")\n  \n  url <- paste0(\n    \"https://data.cms.gov/\",\n    \"provider-data/api/1/metastore/\",\n    \"schemas/dataset/items/\",\n    unname(id[fn]),\n    \"?show-reference-ids=true\")\n  \n  x <- request(url) |>\n       req_perform() |>\n       resp_body_json(\n         check_type = FALSE,\n         simplifyVector = TRUE)\n  \n  x <- list(\n    title        = x[[\"title\"]],\n    description  = x[[\"description\"]],\n    identifier   = x[[\"identifier\"]],\n    distribution = x[[\"distribution\"]][[\"identifier\"]],\n    date         = c(issued   = x[[\"issued\"]], \n                     modified = x[[\"modified\"]], \n                     released = x[[\"released\"]]),\n    landing      = x[[\"landingPage\"]],\n    csv          = x[[\"distribution\"]][[\"data\"]][[\"downloadURL\"]],\n    request      = url,\n    dictionary   = paste0(\n      \"https://data.cms.gov/\",\n      \"provider-data/sites/default/\",\n      \"files/data_dictionaries/physician/\",\n      \"DOC_Data_Dictionary.pdf\"\n      )\n    )\n  \n  url2 <- paste0(\n    \"https://data.cms.gov/\", \n    \"provider-data/api/1/\",\n    \"datastore/query/\", \n    x$distribution, \n    \"?limit=1&offset=100&count=true&results=true\", \n    \"&schema=true&keys=true&format=json&rowIds=true\")\n  \n  y <- request(url2) |>\n       req_perform() |>\n       resp_body_json(\n         check_type = FALSE,\n         simplifyVector = TRUE)\n  \n  yschema <- y[[\"schema\"]][[x[[\"distribution\"]]]][[\"fields\"]]\n  \n  y <- list(\n    dim = c(nrows = y[[\"count\"]],\n            ncols = yschema[[\"record_number\"]][[\"length\"]]),\n    output = data.frame(field = names(y[[\"results\"]]), \n                        value = codex::delist(y[[\"results\"]])),\n    fields = c(\n      yschema[[\"npi\"]][[\"description\"]],\n      yschema[[\"ind_pac_id\"]][[\"description\"]],\n      yschema[[\"provider_last_name\"]][[\"description\"]],\n      yschema[[\"provider_first_name\"]][[\"description\"]],\n      yschema[[\"provider_middle_name\"]][[\"description\"]],\n      yschema[[\"suff\"]][[\"description\"]],\n      yschema[[\"facility_type\"]][[\"description\"]],\n      yschema[[\"facility_affiliations_certification_number\"]][[\"description\"]],\n      yschema[[\"facility_type_certification_number\"]][[\"description\"]]\n    ))\n  \n  c(x, y)\n}\n\nmeta_ndf(\"affiliations\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$title\n[1] \"Facility Affiliation Data\"\n\n$description\n[1] \"This is the facility affiliations data publicly reported in the Provider Data Catalog.\"\n\n$identifier\n[1] \"27ea-46a8\"\n\n$distribution\n[1] \"c0bada3c-9379-5a16-99ec-868e930451d6\"\n\n$date\n      issued     modified     released \n\"2023-08-17\" \"2024-12-02\" \"2024-12-12\" \n\n$landing\n[1] \"https://data.cms.gov/provider-data/dataset/27ea-46a8\"\n\n$csv\n[1] \"https://data.cms.gov/provider-data/sites/default/files/resources/b7c4080ae144663e43353a9c35cd3f53_1733184311/Facility_Affiliation.csv\"\n\n$request\n[1] \"https://data.cms.gov/provider-data/api/1/metastore/schemas/dataset/items/27ea-46a8?show-reference-ids=true\"\n\n$dictionary\n[1] \"https://data.cms.gov/provider-data/sites/default/files/data_dictionaries/physician/DOC_Data_Dictionary.pdf\"\n\n$dim\n  nrows   ncols \n1561449      10 \n\n$output\n                                        field      value\n1                               record_number        501\n2                                         npi 1003006636\n3                                  ind_pac_id 3577699644\n4                          provider_last_name      HASAN\n5                         provider_first_name       SABA\n6                        provider_middle_name    FARHEEN\n7                                        suff           \n8                               facility_type   Hospital\n9  facility_affiliations_certification_number     490046\n10         facility_type_certification_number           \n\n$fields\n[1] \"NPI\"                                       \n[2] \"Ind_PAC_ID\"                                \n[3] \"Provider Last Name\"                        \n[4] \"Provider First Name\"                       \n[5] \"Provider Middle Name\"                      \n[6] \"suff\"                                      \n[7] \"facility_type\"                             \n[8] \"Facility Affiliations Certification Number\"\n[9] \"Facility Type Certification Number\"        \n```\n\n\n:::\n\n```{.r .cell-code}\nmeta_ndf(\"clinicians\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$title\n[1] \"National Downloadable File\"\n\n$description\n[1] \"The Doctors and Clinicians national downloadable file is organized such that each line is unique at the clinician/enrollment record/group/address level. Clinicians with multiple Medicare enrollment records and/or single enrollments linking to multiple practice locations are listed on multiple lines.\"\n\n$identifier\n[1] \"mj5m-pzi6\"\n\n$distribution\n[1] \"21902f69-cf10-57df-b859-94bb4c92e05d\"\n\n$date\n      issued     modified     released \n\"2023-08-17\" \"2024-12-02\" \"2024-12-12\" \n\n$landing\n[1] \"https://data.cms.gov/provider-data/dataset/mj5m-pzi6\"\n\n$csv\n[1] \"https://data.cms.gov/provider-data/sites/default/files/resources/52c3f098d7e56028a298fd297cb0b38d_1733184310/DAC_NationalDownloadableFile.csv\"\n\n$request\n[1] \"https://data.cms.gov/provider-data/api/1/metastore/schemas/dataset/items/mj5m-pzi6?show-reference-ids=true\"\n\n$dictionary\n[1] \"https://data.cms.gov/provider-data/sites/default/files/data_dictionaries/physician/DOC_Data_Dictionary.pdf\"\n\n$dim\n  nrows   ncols \n2595328      10 \n\n$output\n                  field                                                   value\n1         record_number                                                     501\n2                   npi                                              1003002809\n3            ind_pac_id                                              0941350854\n4           ind_enrl_id                                         I20100713000088\n5    provider_last_name                                                GRAZIANO\n6   provider_first_name                                                 VINCENT\n7  provider_middle_name                                                        \n8                  suff                                                        \n9                  gndr                                                       M\n10                 cred                                                      MD\n11              med_sch RUTGERS R W JOHNSON MEDICAL SCHOOL (CAM/NEW BRUNS/PISC)\n12               grd_yr                                                    2004\n13             pri_spec                                    DIAGNOSTIC RADIOLOGY\n14           sec_spec_1                                                        \n15           sec_spec_2                                                        \n16           sec_spec_3                                                        \n17           sec_spec_4                                                        \n18         sec_spec_all                                                        \n19             telehlth                                                        \n20        facility_name           DENVILLE DIAGNOSTICS IMAGING AND OPEN MRI LLC\n21           org_pac_id                                              5496779290\n22          num_org_mem                                                      39\n23             adr_ln_1                                            0100 28TH ST\n24             adr_ln_2                                                        \n25            ln_2_sprs                                                        \n26             citytown                                               FAIR LAWN\n27                state                                                      NJ\n28             zip_code                                               074103786\n29     telephone_number                                              2014751300\n30            ind_assgn                                                       Y\n31            grp_assgn                                                       Y\n32              adrs_id                               NJ074103786FA0100XSTXX300\n\n$fields\n[1] \"NPI\"                  \"Ind_PAC_ID\"           \"Provider Last Name\"  \n[4] \"Provider First Name\"  \"Provider Middle Name\" \"suff\"                \n```\n\n\n:::\n:::\n\n\n\n\n\n# Previous Work\n\n   * [provider(gh issue #60) - version 1](https://github.com/andrewallenbruce/provider/issues/60#issue-2000723817)\n   * [provider(gh issue #60) - version 2](https://github.com/andrewallenbruce/provider/issues/60#issuecomment-1820270391)\n\n# Codebook\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncode <- \\(variable, levels, labels) {\n  dplyr::tibble(\n    variable = variable, \n    level = levels, \n    label = labels)\n}\n\ncode(\n  \"SEX\", \n  levels = c(0, 1), \n  labels = c(\"Male\", \"Female\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 3\n  variable level label \n  <chr>    <dbl> <chr> \n1 SEX          0 Male  \n2 SEX          1 Female\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncodebook <- \\(...) {\n  \n  map <- rlang::list2(...)\n  \n  names(map) <- purrr::map_chr(map, \\(x) x$variable[1])\n  \n  return(map)\n}\n\ncodebook(\n  code(\"SEX\", \n       levels = 0:1, \n       labels = c(\"Male\", \"Female\")), \n  code(\"STUDY\", \n       levels = 1:3, \n       labels = c(\"S1\", \"S2\", \"S3\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$SEX\n# A tibble: 2 × 3\n  variable level label \n  <chr>    <int> <chr> \n1 SEX          0 Male  \n2 SEX          1 Female\n\n$STUDY\n# A tibble: 3 × 3\n  variable level label\n  <chr>    <int> <chr>\n1 STUDY        1 S1   \n2 STUDY        2 S2   \n3 STUDY        3 S3   \n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nencode <- \\(data, codebook) {\n  \n  mapped_vars <- names(codebook)\n  \n  mapped_data <- purrr::map2(data, names(data), \\(x, var, m) {\n      \n      if (!var %in% mapped_vars) return(x)\n      \n      x <- factor(x, levels = m[[var]]$level, labels = m[[var]]$label)\n      \n      return(x)\n    },\n    m <- codebook\n  )\n  dplyr::as_tibble(mapped_data)\n}\n\nlabels <- codebook(\n  code(\"SEX\", \n       levels = 0:1, \n       labels = c(\"Male\", \"Female\")), \n  code(\"STUDY\", \n       levels = 1:3, \n       labels = c(\"S1\", \"S2\", \"S3\"))\n  )\n\ndataset <- data.frame(\n  STUDY = c(1, 1, 1, 2, 2, 2),\n  SEX   = c(0, 0, 1, 1, 1, 0),\n  AGE   = c(32, 18, 64, 52, 26, 80)\n)\n\nencode(dataset, labels)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  STUDY SEX      AGE\n  <fct> <fct>  <dbl>\n1 S1    Male      32\n2 S1    Male      18\n3 S1    Female    64\n4 S2    Female    52\n5 S2    Female    26\n6 S2    Male      80\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndecode <- \\(data, codebook) {\n  \n  mapped_vars <- names(codebook)\n  \n  mapped_data <- purrr::map2(data, names(data), \\(x, var, m) {\n    \n      if (!var %in% mapped_vars) return(x)\n    \n      x_chr <- as.character(x)\n      \n      x_lvl <- m[[var]]$level\n      \n      x_lab <- m[[var]]$label\n      \n      x <- x_lvl[match(x_chr, x_lab)]\n      \n      return(x)\n    },\n    m <- codebook\n  )\n  dplyr::as_tibble(mapped_data)\n}\n\nlabels <- codebook(\n code(\"SEX\", levels = c(0, 1), labels = c(\"Male\", \"Female\")),\n code(\"STUDY\", levels = c(1, 2, 3), labels = c(\"S1\", \"S2\", \"S3\")))\n\ndataset <- data.frame(\n  STUDY = factor(c(\"S1\", \"S1\", \"S1\", \"S2\", \"S2\", \"S2\")),\n  SEX   = factor(c(\"Male\", \"Male\", \"Female\", \"Female\", \"Female\", \"Male\")),\n  AGE   = c(32, 18, 64, 52, 26, 80))\n\ndecode(dataset, labels)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  STUDY   SEX   AGE\n  <dbl> <dbl> <dbl>\n1     1     0    32\n2     1     0    18\n3     1     1    64\n4     2     1    52\n5     2     1    26\n6     2     0    80\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}