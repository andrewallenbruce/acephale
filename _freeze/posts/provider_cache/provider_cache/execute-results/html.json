{
  "hash": "3cf09f6da46943d42a395c044fd45778",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"provider: Metadata Caching\"\nformat:\n  html:\n    reference-location: block\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n# National Downloadable File\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmeta_ndf <- \\(fname) {\n  \n  stopifnot(curl::has_internet())\n  \n  x <- request(\n    paste0(\n      \"https://data.cms.gov/\",\n      \"provider-data/api/1/\",\n      \"metastore/schemas/\",\n      \"dataset/items/\",\n      switch(fname, \n             affiliations = \"27ea-46a8\", \n             clinicians   = \"mj5m-pzi6\", \n             stop(\"Invalid argument\")),\n    \"?show-reference-ids=true\")) |>\n       req_perform() |>\n       resp_body_json(\n         check_type     = FALSE,\n         simplifyVector = TRUE)\n  \n  distro <- gelm(\n    gelm(\n      x,\n      \"distribution\"), \n    \"identifier\")\n  \n  y <- request(\n    paste0(\n    \"https://data.cms.gov/\", \n    \"provider-data/api/1/\",\n    \"datastore/query/\", \n    distro, \n    \"?limit=1&offset=100&\",\n    \"count=true&results=true&\", \n    \"schema=true&keys=true&\",\n    \"format=json&rowIds=true\")) |>\n       req_perform() |>\n       resp_body_json(\n         check_type = FALSE,\n         simplifyVector = TRUE)\n  \n  z <- gelm(gelm(gelm(\n        y, \n        \"schema\"), \n      distro), \n    \"fields\")\n  \n  out <- list(\n    title        = gelm(x, \"title\"),\n    description  = gelm(x, \"description\"),\n    identifier   = gelm(gelm(x, \"identifier\"), \"identifier\"),\n    distribution = distro,\n    issued       = gelm(x, \"issued\"), \n    modified     = gelm(x, \"modified\")[[1]], \n    released     = gelm(x, \"released\"),\n    dimension    = str_glue('{gelm(gelm(y, \"count\"), is.numeric)} x {gelm(gelm(z, \"record_number\"), \"length\")}'), \n    fields       = delist(getelem(z[names(z)], \"description\")),\n    site         = gelm(x, \"landingPage\"),\n    csv          = gelm(gelm(gelm(x, \"distribution\"), \"data\"), \"downloadURL\", m = \"df\"),\n    dictionary   = paste0(\"https://data.cms.gov/provider-data/sites/default/files/data_dictionaries/physician/DOC_Data_Dictionary.pdf\"))\n  \n  out\n}\n\nmeta_ndf(\"affiliations\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$title\n[1] \"Facility Affiliation Data\"\n\n$description\n[1] \"This is the facility affiliations data publicly reported in the Provider Data Catalog.\"\n\n$identifier\n[1] \"27ea-46a8\"\n\n$distribution\n[1] \"c0bada3c-9379-5a16-99ec-868e930451d6\"\n\n$issued\n[1] \"2023-08-17\"\n\n$modified\n[1] \"2024-12-02\"\n\n$released\n[1] \"2024-12-12\"\n\n$dimension\n1561449 x 10\n\n$fields\n[1] \"NPI\"                                       \n[2] \"Ind_PAC_ID\"                                \n[3] \"Provider Last Name\"                        \n[4] \"Provider First Name\"                       \n[5] \"Provider Middle Name\"                      \n[6] \"suff\"                                      \n[7] \"facility_type\"                             \n[8] \"Facility Affiliations Certification Number\"\n[9] \"Facility Type Certification Number\"        \n\n$site\n[1] \"https://data.cms.gov/provider-data/dataset/27ea-46a8\"\n\n$csv\n[1] \"https://data.cms.gov/provider-data/sites/default/files/resources/b7c4080ae144663e43353a9c35cd3f53_1733184311/Facility_Affiliation.csv\"\n\n$dictionary\n[1] \"https://data.cms.gov/provider-data/sites/default/files/data_dictionaries/physician/DOC_Data_Dictionary.pdf\"\n```\n\n\n:::\n\n```{.r .cell-code}\nmeta_ndf(\"clinicians\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$title\n[1] \"National Downloadable File\"\n\n$description\n[1] \"The Doctors and Clinicians national downloadable file is organized such that each line is unique at the clinician/enrollment record/group/address level. Clinicians with multiple Medicare enrollment records and/or single enrollments linking to multiple practice locations are listed on multiple lines.\"\n\n$identifier\n[1] \"mj5m-pzi6\"\n\n$distribution\n[1] \"21902f69-cf10-57df-b859-94bb4c92e05d\"\n\n$issued\n[1] \"2023-08-17\"\n\n$modified\n[1] \"2024-12-02\"\n\n$released\n[1] \"2024-12-12\"\n\n$dimension\n2595328 x 10\n\n$fields\n [1] \"NPI\"                  \"Ind_PAC_ID\"           \"Ind_enrl_ID\"         \n [4] \"Provider Last Name\"   \"Provider First Name\"  \"Provider Middle Name\"\n [7] \"suff\"                 \"gndr\"                 \"Cred\"                \n[10] \"Med_sch\"              \"Grd_yr\"               \"pri_spec\"            \n[13] \"sec_spec_1\"           \"sec_spec_2\"           \"sec_spec_3\"          \n[16] \"sec_spec_4\"           \"sec_spec_all\"         \"Telehlth\"            \n[19] \"Facility Name\"        \"org_pac_id\"           \"num_org_mem\"         \n[22] \"adr_ln_1\"             \"adr_ln_2\"             \"ln_2_sprs\"           \n[25] \"City/Town\"            \"State\"                \"ZIP Code\"            \n[28] \"Telephone Number\"     \"ind_assgn\"            \"grp_assgn\"           \n[31] \"adrs_id\"             \n\n$site\n[1] \"https://data.cms.gov/provider-data/dataset/mj5m-pzi6\"\n\n$csv\n[1] \"https://data.cms.gov/provider-data/sites/default/files/resources/52c3f098d7e56028a298fd297cb0b38d_1733184310/DAC_NationalDownloadableFile.csv\"\n\n$dictionary\n[1] \"https://data.cms.gov/provider-data/sites/default/files/data_dictionaries/physician/DOC_Data_Dictionary.pdf\"\n```\n\n\n:::\n:::\n\n\n\n\n# Previous Work\n\n   * [provider(gh issue #60) - version 1](https://github.com/andrewallenbruce/provider/issues/60#issue-2000723817)\n   * [provider(gh issue #60) - version 2](https://github.com/andrewallenbruce/provider/issues/60#issuecomment-1820270391)\n\n# Codebook\n\n## Code\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncode <- \\(variable, levels, labels) {\n  dplyr::tibble(\n    variable = variable, \n    level = levels, \n    label = labels)\n}\n\ncode(\n  \"SEX\", \n  levels = c(0, 1), \n  labels = c(\"Male\", \"Female\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 3\n  variable level label \n  <chr>    <dbl> <chr> \n1 SEX          0 Male  \n2 SEX          1 Female\n```\n\n\n:::\n:::\n\n\n\n\n## Codebook\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncodebook <- \\(...) {\n  \n  map <- rlang::list2(...)\n  \n  names(map) <- purrr::map_chr(map, \\(x) x$variable[1])\n  \n  return(map)\n}\n\ncodebook(\n  code(\"SEX\", \n       levels = 0:1, \n       labels = c(\"Male\", \"Female\")), \n  code(\"STUDY\", \n       levels = 1:3, \n       labels = c(\"S1\", \"S2\", \"S3\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$SEX\n# A tibble: 2 × 3\n  variable level label \n  <chr>    <int> <chr> \n1 SEX          0 Male  \n2 SEX          1 Female\n\n$STUDY\n# A tibble: 3 × 3\n  variable level label\n  <chr>    <int> <chr>\n1 STUDY        1 S1   \n2 STUDY        2 S2   \n3 STUDY        3 S3   \n```\n\n\n:::\n:::\n\n\n\n\n## Encode\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nencode <- \\(data, codebook) {\n  \n  mapped_vars <- names(codebook)\n  \n  mapped_data <- purrr::map2(data, names(data), \\(x, var, m) {\n      \n      if (!var %in% mapped_vars) return(x)\n      \n      x <- factor(x, levels = m[[var]]$level, labels = m[[var]]$label)\n      \n      return(x)\n    },\n    m <- codebook\n  )\n  dplyr::as_tibble(mapped_data)\n}\n\nlabels <- codebook(\n  code(\"SEX\", \n       levels = 0:1, \n       labels = c(\"Male\", \"Female\")), \n  code(\"STUDY\", \n       levels = 1:3, \n       labels = c(\"S1\", \"S2\", \"S3\"))\n  )\n\ndataset <- data.frame(\n  STUDY = c(1, 1, 1, 2, 2, 2),\n  SEX   = c(0, 0, 1, 1, 1, 0),\n  AGE   = c(32, 18, 64, 52, 26, 80)\n)\n\nencode(dataset, labels)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  STUDY SEX      AGE\n  <fct> <fct>  <dbl>\n1 S1    Male      32\n2 S1    Male      18\n3 S1    Female    64\n4 S2    Female    52\n5 S2    Female    26\n6 S2    Male      80\n```\n\n\n:::\n:::\n\n\n\n\n## Decode\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndecode <- \\(data, codebook) {\n  \n  mapped_vars <- names(codebook)\n  \n  mapped_data <- purrr::map2(data, names(data), \\(x, var, m) {\n    \n      if (!var %in% mapped_vars) return(x)\n    \n      x_chr <- as.character(x)\n      \n      x_lvl <- m[[var]]$level\n      \n      x_lab <- m[[var]]$label\n      \n      x <- x_lvl[match(x_chr, x_lab)]\n      \n      return(x)\n    },\n    m <- codebook\n  )\n  dplyr::as_tibble(mapped_data)\n}\n\nlabels <- codebook(\n code(\"SEX\", levels = c(0, 1), labels = c(\"Male\", \"Female\")),\n code(\"STUDY\", levels = c(1, 2, 3), labels = c(\"S1\", \"S2\", \"S3\")))\n\ndataset <- data.frame(\n  STUDY = factor(c(\"S1\", \"S1\", \"S1\", \"S2\", \"S2\", \"S2\")),\n  SEX   = factor(c(\"Male\", \"Male\", \"Female\", \"Female\", \"Female\", \"Male\")),\n  AGE   = c(32, 18, 64, 52, 26, 80))\n\ndecode(dataset, labels)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  STUDY   SEX   AGE\n  <dbl> <dbl> <dbl>\n1     1     0    32\n2     1     0    18\n3     1     1    64\n4     2     1    52\n5     2     1    26\n6     2     0    80\n```\n\n\n:::\n:::\n\n\n\n\n--------------------------------------------------------------------------------\n\n\n## Session Information \n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n**R version 4.4.2 (2024-10-31 ucrt)**\n\n**Platform:** x86_64-w64-mingw32/x64 \n\n**locale:**\n_LC_COLLATE=English_United States.utf8_, _LC_CTYPE=English_United States.utf8_, _LC_MONETARY=English_United States.utf8_, _LC_NUMERIC=C_ and _LC_TIME=English_United States.utf8_\n\n**attached base packages:** \n_stats_, _graphics_, _grDevices_, _utils_, _datasets_, _methods_ and _base_\n\n**other attached packages:** \n_httr2(v.1.0.7)_, _codex(v.0.0.1)_, _provider(v.0.0.1.9000)_, _collapse(v.2.0.18)_, _kit(v.0.0.19)_, _magrittr(v.2.0.3)_, _data.table(v.1.16.99)_, _fastverse(v.0.3.4)_, _lubridate(v.1.9.4)_, _forcats(v.1.0.0)_, _stringr(v.1.5.1)_, _dplyr(v.1.1.4)_, _purrr(v.1.0.2)_, _readr(v.2.1.5)_, _tidyr(v.1.3.1.9000)_, _tibble(v.3.2.1)_, _ggplot2(v.3.5.1)_ and _tidyverse(v.2.0.0)_\n\n**loaded via a namespace (and not attached):** \n_rappdirs(v.0.3.3)_, _utf8(v.1.2.4)_, _generics(v.0.1.3)_, _stringi(v.1.8.4)_, _hms(v.1.1.3)_, _digest(v.0.6.37)_, _evaluate(v.1.0.1)_, _grid(v.4.4.2)_, _timechange(v.0.3.0)_, _fastmap(v.1.2.0)_, _jsonlite(v.1.8.9)_, _pander(v.0.6.5)_, _fansi(v.1.0.6)_, _fuimus(v.0.0.5.9003)_, _scales(v.1.3.0)_, _textshaping(v.0.4.1)_, _cli(v.3.6.3)_, _crayon(v.1.5.3)_, _rlang(v.1.1.4)_, _munsell(v.0.5.1)_, _withr(v.3.0.2)_, _yaml(v.2.3.10)_, _tools(v.4.4.2)_, _parallel(v.4.4.2)_, _tzdb(v.0.4.0)_, _zeallot(v.0.1.0)_, _colorspace(v.2.1-1)_, _curl(v.6.0.1)_, _vctrs(v.0.6.5)_, _R6(v.2.5.1)_, _lifecycle(v.1.0.4)_, _cheapr(v.0.9.92)_, _htmlwidgets(v.1.6.4)_, _ragg(v.1.3.3)_, _pkgconfig(v.2.0.3)_, _pillar(v.1.9.0)_, _gtable(v.0.3.6)_, _glue(v.1.8.0)_, _Rcpp(v.1.0.13-1)_, _systemfonts(v.1.1.0)_, _xfun(v.0.49)_, _tidyselect(v.1.2.1)_, _rstudioapi(v.0.17.1)_, _knitr(v.1.49)_, _htmltools(v.0.5.8.1)_, _rmarkdown(v.2.29)_ and _compiler(v.4.4.2)_\n:::\n:::\n",
    "supporting": [
      "provider_cache_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}